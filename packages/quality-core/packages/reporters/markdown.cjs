/**
 * Markdown Reporter
 * Generates a human-readable markdown report from audit results.
 */

function generateMarkdown(result) {
    const { meta, scores, violations, status } = result;

    const icon = status === 'pass' ? 'âœ…' : 'âŒ';
    const date = new Date(meta.timestamp).toLocaleString();

    let md = `# ${icon} Quality Gate Report\n\n`;
    md += `**Project:** ${meta.project}\n`;
    md += `**Commit:** \`${meta.commit}\`\n`;
    md += `**Date:** ${date}\n`;
    md += `**Preset:** \`${meta.preset}\`\n\n`;

    md += `## ðŸ“Š Scores\n\n`;
    md += `| Category | Score | Status |\n`;
    md += `| :--- | :---: | :---: |\n`;

    for (const [key, value] of Object.entries(scores)) {
        const s = Math.round(value);
        const icon = s >= 90 ? 'ðŸŸ¢' : (s >= 50 ? 'ðŸŸ¡' : 'ðŸ”´');
        md += `| ${key} | ${s} | ${icon} |\n`;
    }

    md += `\n## ðŸš¨ Violations\n\n`;

    if (violations.length === 0) {
        md += `> ðŸŽ‰ No violations found. Quality is high.\n`;
    } else {
        // Group by severity
        const errors = violations.filter(v => v.severity === 'error');
        const warnings = violations.filter(v => v.severity === 'warn');

        if (errors.length > 0) {
            md += `### Errors (${errors.length})\n`;
            for (const v of errors) {
                const val = typeof v.value === 'object' ? JSON.stringify(v.value) : v.value;
                const threshold = typeof v.threshold === 'object' ? JSON.stringify(v.threshold) : v.threshold;
                const message = typeof v.message === 'object' ? JSON.stringify(v.message) : v.message;

                md += `- ðŸ”´ **[${v.area}]** ${v.metric}: \`${val}\` (Threshold: \`${threshold}\`)\n`;
                if (message) md += `  - *${message}*\n`;
                if (v.selector) md += `  - Element: \`${v.selector}\`\n`;
            }
            md += `\n`;
        }

        if (warnings.length > 0) {
            md += `### Warnings (${warnings.length})\n`;
            for (const v of warnings) {
                const val = typeof v.value === 'object' ? JSON.stringify(v.value) : v.value;
                const threshold = typeof v.threshold === 'object' ? JSON.stringify(v.threshold) : v.threshold;
                const message = typeof v.message === 'object' ? JSON.stringify(v.message) : v.message;

                md += `- ðŸŸ¡ **[${v.area}]** ${v.metric}: \`${val}\` (Threshold: \`${threshold}\`)\n`;
                if (message) md += `  - *${message}*\n`;
                if (v.selector) md += `  - Element: \`${v.selector}\`\n`;
            }
        }
    }

    md += `\n---\n*Generated by Quality Core*\n`;

    return md;
}

const MarkdownReporter = {
    generate: generateMarkdown
};

module.exports = MarkdownReporter;
