<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quality Core Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
          colors: {
            background: 'var(--bg-background)',
            surface: 'var(--bg-surface)',
            surfaceHighlight: 'var(--bg-highlight)',
            border: 'var(--border-color)',
            primary: 'var(--color-primary)',
            primaryGlow: 'var(--color-primary-glow)',
            success: '#10b981',
            warning: '#f59e0b',
            error: '#ef4444',
            text: 'var(--text-main)',
            muted: 'var(--text-muted)'
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --bg-background: #050505;
      --bg-surface: #0f0f0f;
      --bg-highlight: #1A1A1A;
      --border-color: rgba(255, 255, 255, 0.12);
      --text-main: #EAEAEA;
      --text-muted: #a3a3a3;
      --color-primary: #22d3ee;
      --color-primary-glow: rgba(34, 211, 238, 0.2);
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-background);
      background-image: radial-gradient(circle at 50% -10%, #1a1a1a 0%, #050505 50%);
      background-attachment: fixed;
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    /* Noise Overlay */
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: 50;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
      opacity: 0.5;
      mix-blend-mode: overlay;
    }

    .glass-card {
      background: var(--bg-surface);
      background-image: linear-gradient(180deg, rgba(20, 20, 20, 0.8) 0%, rgba(10, 10, 10, 0.9) 100%);
      box-shadow: 0 0 0 1px var(--border-color);
      border-radius: 12px;
    }
    .glass-card:hover {
      box-shadow: 0 0 0 1px var(--border-color), inset 0 0 20px rgba(255,255,255,0.02);
    }

    .sidebar-link { 
      transition: all 0.2s; 
      border-left: 2px solid transparent; 
    }
    .sidebar-link:hover, .sidebar-link.active { 
      background: rgba(34, 211, 238, 0.05); 
      color: var(--color-primary); 
      border-left-color: var(--color-primary); 
    }
    .sidebar-link.active::after {
      content: "";
      position: absolute;
      right: 12px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--color-primary);
      box-shadow: 0 0 8px var(--color-primary);
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* Prose */
    .prose h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: var(--text-main); }
    .prose h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #e4e4e7; }
    .prose h3 { font-size: 1.1rem; font-weight: 600; margin-top: 1.25rem; margin-bottom: 0.5rem; color: #d4d4d8; }
    .prose p { margin-bottom: 1rem; color: var(--text-muted); line-height: 1.6; }
    .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; color: var(--text-muted); }
    .prose code { background: rgba(255,255,255,0.1); padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
    .prose pre { background: #1a1a20; padding: 1rem; border-radius: 8px; overflow-x: auto; margin-bottom: 1rem; }
    .prose pre code { background: transparent; padding: 0; }
    .prose table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
    .prose th, .prose td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); }
    .prose th { color: var(--text-main); font-weight: 600; background: var(--bg-highlight); }
    .prose a { color: var(--color-primary); text-decoration: none; }
    .prose a:hover { text-decoration: underline; }

    /* Collapsed Sidebar */
    .sidebar-collapsed { width: 80px !important; }
    .sidebar-collapsed .sidebar-text { display: none; }
    .sidebar-collapsed .sidebar-header { justify-content: center; }
    .sidebar-collapsed .sidebar-link { justify-content: center; padding-left: 0; padding-right: 0; }
  </style>
</head>
<body class="h-screen flex overflow-hidden selection:bg-primary selection:text-black">
  
  <!-- Sidebar -->
  <aside id="sidebar" class="w-64 bg-surface/80 backdrop-blur-xl border-r border-white/5 flex flex-col z-20 shrink-0 transition-all duration-300">
    <!-- Header -->
    <div class="p-6 sidebar-header flex items-center justify-between">
      <a href="#" onclick="switchTab('dashboard'); return false;" class="flex items-center gap-3">
        <span class="text-3xl">‚ö°</span>
        <div class="sidebar-text">
          <div class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-purple-500">Quality Core</div>
          <p class="text-xs text-muted uppercase tracking-wider">Dashboard</p>
        </div>
      </a>
      <button onclick="toggleSidebar()" class="text-muted hover:text-primary transition p-2 rounded-lg hover:bg-white/5" title="Toggle Sidebar">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>
    </div>

    <!-- Nav Items -->
    <nav class="flex-1 px-4 space-y-2 mt-2 overflow-y-auto" id="nav-links">
      <button onclick="switchTab('dashboard')" class="w-full sidebar-link active flex items-center gap-3 px-4 py-3 text-sm font-medium text-muted rounded-r-lg relative">
        <span>üìä</span><span class="sidebar-text">Dashboard</span>
      </button>
      <button onclick="switchTab('profile')" class="w-full sidebar-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-muted rounded-r-lg relative">
        <span>üìã</span><span class="sidebar-text">Site Profile</span>
      </button>
      <button onclick="switchTab('quality')" class="w-full sidebar-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-muted rounded-r-lg relative">
        <span>üõ°Ô∏è</span><span class="sidebar-text">Quality Scans</span>
      </button>
      <button onclick="switchTab('monitor')" class="w-full sidebar-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-muted rounded-r-lg relative">
        <span>üì°</span><span class="sidebar-text">Site Monitor</span>
      </button>
      <button onclick="switchTab('pagespeed')" class="w-full sidebar-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-muted rounded-r-lg relative">
        <span>üî•</span><span class="sidebar-text">PageSpeed</span>
      </button>
      <button onclick="switchTab('git')" class="w-full sidebar-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-muted rounded-r-lg relative">
        <span>üîÄ</span><span class="sidebar-text">Git & Deploy</span>
      </button>
      <button onclick="switchTab('reports')" class="w-full sidebar-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-muted rounded-r-lg relative">
        <span>üî¶</span><span class="sidebar-text">Lighthouse</span>
      </button>
      <button onclick="switchTab('logs')" class="w-full sidebar-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-muted rounded-r-lg relative">
        <span>üìù</span><span class="sidebar-text">Logs</span>
      </button>
    </nav>

    <!-- Footer Actions -->
    <div class="p-4 border-t border-white/5 space-y-2">
      <div class="glass-card p-4">
        <h4 class="text-xs font-bold text-muted uppercase mb-3 sidebar-text">Quick Actions</h4>
        <div class="space-y-2">
          <button onclick="runCommand('quality')" class="w-full text-left px-3 py-2 text-xs font-medium bg-primary/10 text-primary rounded hover:bg-primary/20 transition flex items-center gap-2">
            <span>üöÄ</span><span class="sidebar-text">Run Quality</span>
          </button>
          <button onclick="runCommand('lighthouse')" class="w-full text-left px-3 py-2 text-xs font-medium bg-surfaceHighlight text-muted rounded hover:bg-white/5 transition flex items-center gap-2">
            <span>üî¶</span><span class="sidebar-text">Run Perf</span>
          </button>
        </div>
      </div>
      
      <!-- Settings Button -->
      <button onclick="openSettings()" class="w-full sidebar-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-muted rounded-lg relative">
        <span>‚öôÔ∏è</span><span class="sidebar-text">Settings</span>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 overflow-auto relative bg-background">
    <div class="max-w-7xl mx-auto p-8 relative z-10" id="content-area">
      <!-- Content injected via JS -->
    </div>
  </main>

  <!-- Terminal Modal -->
  <div id="terminal-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-surface border border-white/10 rounded-2xl w-full max-w-4xl h-[600px] flex flex-col shadow-2xl relative overflow-hidden">
      <div class="p-4 border-b border-white/10 flex justify-between items-center bg-surfaceHighlight">
        <div class="flex items-center gap-3">
          <span class="w-3 h-3 rounded-full bg-red-500"></span>
          <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
          <span class="w-3 h-3 rounded-full bg-green-500"></span>
          <span class="ml-2 font-mono text-xs text-muted" id="terminal-title">Terminal</span>
        </div>
        <button onclick="closeTerminal()" class="text-muted hover:text-white transition">‚úï</button>
      </div>
      <div class="flex-1 p-4 overflow-auto bg-[#0c0c0c] font-mono text-xs text-gray-300 leading-relaxed whitespace-pre-wrap break-words" id="terminal-content"></div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-surface border border-white/10 rounded-2xl w-full max-w-2xl max-h-[90vh] flex flex-col shadow-2xl relative overflow-hidden">
      <div class="p-6 border-b border-white/10 flex justify-between items-center">
        <h2 class="text-xl font-bold text-white">‚öôÔ∏è Settings</h2>
        <button onclick="closeSettings()" class="text-muted hover:text-white transition text-xl">‚úï</button>
      </div>
      
      <!-- Settings Tabs -->
      <div class="flex border-b border-white/10 px-6">
        <button onclick="switchSettingsTab('profile')" class="settings-tab active px-4 py-3 text-sm font-medium text-muted border-b-2 border-transparent" data-tab="profile">üìã Profile</button>
        <button onclick="switchSettingsTab('api')" class="settings-tab px-4 py-3 text-sm font-medium text-muted border-b-2 border-transparent" data-tab="api">üîë API Keys</button>
      </div>

      <div class="p-6 overflow-y-auto flex-1">
        <!-- Profile Tab -->
        <div id="settings-profile-tab" class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-muted mb-2">Project Name</label>
            <input type="text" id="project-name-input" placeholder="My Project" 
              class="w-full px-4 py-3 bg-surfaceHighlight border border-white/10 rounded-lg text-white placeholder-muted focus:border-primary focus:outline-none">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-muted mb-2">Published Site URL</label>
            <input type="url" id="monitor-url-input" placeholder="https://yourname.github.io/project/" 
              class="w-full px-4 py-3 bg-surfaceHighlight border border-white/10 rounded-lg text-white placeholder-muted focus:border-primary focus:outline-none"
              onchange="autoDetectGitHub()">
            <p class="text-xs text-muted mt-2">GitHub repo will be auto-detected from .github.io URLs</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-muted mb-2">GitHub Repository</label>
            <input type="text" id="github-repo-input" placeholder="owner/repo" 
              class="w-full px-4 py-3 bg-surfaceHighlight border border-white/10 rounded-lg text-white placeholder-muted focus:border-primary focus:outline-none">
          </div>
        </div>
        
        <!-- API Tab -->
        <div id="settings-api-tab" class="space-y-6 hidden">
          <div>
            <label class="block text-sm font-medium text-muted mb-2">GitHub Token</label>
            <div class="flex gap-2">
              <input type="password" id="github-token-input" placeholder="ghp_xxxxxxxxxxxxx" 
                class="flex-1 px-4 py-2 bg-surfaceHighlight border border-white/10 rounded-lg text-white placeholder-muted focus:border-primary focus:outline-none transition-all">
              <button id="verify-github-btn" onclick="verifyGitHubToken()" class="px-3 py-2 bg-white/5 hover:bg-white/10 text-muted rounded-lg text-xs font-medium transition-all flex items-center gap-2">
                <span id="github-status-icon">üîç</span> Verify
              </button>
            </div>
            <p class="text-[10px] text-muted mt-2">For Actions status and commits. Never sent to server.</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-muted mb-2">Google PageSpeed API Key</label>
            <div class="flex gap-2">
              <input type="password" id="pagespeed-key-input" placeholder="AIzaSy..." 
                class="flex-1 px-4 py-2 bg-surfaceHighlight border border-white/10 rounded-lg text-white placeholder-muted focus:border-primary focus:outline-none transition-all">
              <button id="verify-pagespeed-btn" onclick="verifyPageSpeedKey()" class="px-3 py-2 bg-white/5 hover:bg-white/10 text-muted rounded-lg text-xs font-medium transition-all flex items-center gap-2">
                <span id="pagespeed-status-icon">üîç</span> Verify
              </button>
            </div>
            <p class="text-[10px] text-muted mt-2">For remote Lighthouse tests. <a href="https://developers.google.com/speed/docs/insights/v5/get-started" target="_blank" class="text-primary hover:underline">Get API Key</a></p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-muted mb-2">Gemini API Key</label>
            <div class="flex gap-2">
              <input type="password" id="gemini-key-input" placeholder="AIzaSy..." 
                class="flex-1 px-4 py-2 bg-surfaceHighlight border border-white/10 rounded-lg text-white placeholder-muted focus:border-primary focus:outline-none transition-all">
              <button id="verify-gemini-btn" onclick="verifyGeminiKey()" class="px-3 py-2 bg-white/5 hover:bg-white/10 text-muted rounded-lg text-xs font-medium transition-all flex items-center gap-2">
                <span id="gemini-status-icon">üîç</span> Verify
              </button>
            </div>
            <p class="text-[10px] text-muted mt-2">For AI-powered insights and commit messages. <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-primary hover:underline">Get API Key</a></p>
          </div>
          
          <button onclick="clearApiKeys()" class="text-xs text-error hover:underline">Clear All API Keys</button>
        </div>
      </div>
      
      <div class="p-6 border-t border-white/10">
        <button onclick="saveSettings()" class="w-full py-3 bg-primary text-black font-bold rounded-lg hover:bg-primary/90 transition">
          Save Settings
        </button>
      </div>
    </div>
  </div>

  <script>
    // --- State & Config ---
    let currentTab = 'dashboard';
    let sidebarCollapsed = false;
    let trendChart = null;
    const API_BASE = '/api';

    // --- API Verification ---
    async function verifyGitHubToken() {
      const token = document.getElementById('github-token-input').value.trim();
      if (!token) return;
      
      const btn = document.getElementById('verify-github-btn');
      const input = document.getElementById('github-token-input');
      const icon = document.getElementById('github-status-icon');
      
      btn.disabled = true;
      icon.innerHTML = '‚è≥';
      icon.className = 'animate-spin';
      
      try {
        const res = await fetch(`${API_BASE}/verify/github`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });
        const json = await res.json();
        
        if (json.success) {
          input.classList.remove('border-white/10', 'border-error');
          input.classList.add('border-success');
          icon.innerHTML = '‚úÖ';
          icon.className = '';
          
          // Display scopes
          const settings = getSettings();
          settings.githubScopes = json.scopes;
          saveSettingsData(settings);
          
          alert(`Token Valid! Scopes: ${json.scopes.join(', ')}`);
        } else {
          throw new Error();
        }
      } catch {
        input.classList.remove('border-white/10', 'border-success');
        input.classList.add('border-error');
        icon.innerHTML = '‚ùå';
        icon.className = '';
      }
      btn.disabled = false;
    }

    async function verifyPageSpeedKey() {
      const key = document.getElementById('pagespeed-key-input').value.trim();
      if (!key) return;
      
      const btn = document.getElementById('verify-pagespeed-btn');
      const input = document.getElementById('pagespeed-key-input');
      const icon = document.getElementById('pagespeed-status-icon');
      
      btn.disabled = true;
      icon.innerHTML = '‚è≥';
      icon.className = 'animate-spin';
      
      try {
        // Test with a generic Google URL
        const res = await fetch(`https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://www.google.com&key=${key}`);
        if (res.ok) {
          input.classList.remove('border-white/10', 'border-error');
          input.classList.add('border-success');
          icon.innerHTML = '‚úÖ';
          icon.className = '';
        } else {
          throw new Error();
        }
      } catch {
        input.classList.remove('border-white/10', 'border-success');
        input.classList.add('border-error');
        icon.innerHTML = '‚ùå';
        icon.className = '';
      }
      btn.disabled = false;
    }

    async function verifyGeminiKey() {
      const key = document.getElementById('gemini-key-input').value.trim();
      if (!key) return;
      
      const btn = document.getElementById('verify-gemini-btn');
      const input = document.getElementById('gemini-key-input');
      const icon = document.getElementById('gemini-status-icon');
      
      btn.disabled = true;
      icon.innerHTML = '‚è≥';
      icon.className = 'animate-spin';
      
      try {
        const res = await fetch(`${API_BASE}/verify/gemini`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key })
        });
        
        const json = await res.json();
        
        if (json.success) {
          input.classList.remove('border-white/10', 'border-error');
          input.classList.add('border-success');
          icon.innerHTML = '‚úÖ';
          icon.className = '';
        } else {
          console.error('Gemini Verification Failed:', json.error);
          throw new Error(json.error || 'Verification failed');
        }
      } catch (e) {
        console.error('Gemini Error:', e);
        input.classList.remove('border-white/10', 'border-success');
        input.classList.add('border-error');
        icon.innerHTML = '‚ùå';
        icon.className = '';
      }
      btn.disabled = false;
    }

    // --- Settings (localStorage) ---
    function getSettings() {
      try {
        return JSON.parse(localStorage.getItem('quality_dashboard_settings') || '{}');
      } catch { return {}; }
    }
    
    function saveSettingsData(data) {
      localStorage.setItem('quality_dashboard_settings', JSON.stringify(data));
    }

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      loadDashboard();
    });

    // --- Sidebar Toggle ---
    function toggleSidebar() {
      sidebarCollapsed = !sidebarCollapsed;
      const sidebar = document.getElementById('sidebar');
      if (sidebarCollapsed) {
        sidebar.classList.add('sidebar-collapsed');
      } else {
        sidebar.classList.remove('sidebar-collapsed');
      }
    }

    // --- Settings Tabs ---
    function switchSettingsTab(tab) {
      document.querySelectorAll('.settings-tab').forEach(btn => {
        if (btn.dataset.tab === tab) {
          btn.classList.add('active', 'border-primary', 'text-primary');
        } else {
          btn.classList.remove('active', 'border-primary', 'text-primary');
        }
      });
      document.getElementById('settings-profile-tab').classList.toggle('hidden', tab !== 'profile');
      document.getElementById('settings-api-tab').classList.toggle('hidden', tab !== 'api');
    }

    // Auto-detect GitHub repo from .github.io URLs
    function autoDetectGitHub() {
      const url = document.getElementById('monitor-url-input').value;
      const match = url.match(/https?:\/\/([^.]+)\.github\.io\/([^\/]+)/);
      if (match) {
        document.getElementById('github-repo-input').value = `${match[1]}/${match[2]}`;
      }
    }

    // --- Settings Modal ---
    function openSettings() {
      const settings = getSettings();
      document.getElementById('project-name-input').value = settings.projectName || '';
      document.getElementById('github-token-input').value = settings.githubToken || '';
      document.getElementById('monitor-url-input').value = settings.monitorUrl || '';
      document.getElementById('github-repo-input').value = settings.githubRepo || '';
      document.getElementById('pagespeed-key-input').value = settings.pagespeedKey || '';
      document.getElementById('gemini-key-input').value = settings.geminiKey || '';
      switchSettingsTab('profile');
      document.getElementById('settings-modal').classList.remove('hidden');
    }
    
    function closeSettings() {
      document.getElementById('settings-modal').classList.add('hidden');
    }
    
    function saveSettings() {
      const data = {
        projectName: document.getElementById('project-name-input').value.trim(),
        githubToken: document.getElementById('github-token-input').value.trim(),
        monitorUrl: document.getElementById('monitor-url-input').value.trim(),
        githubRepo: document.getElementById('github-repo-input').value.trim(),
        pagespeedKey: document.getElementById('pagespeed-key-input').value.trim(),
        geminiKey: document.getElementById('gemini-key-input').value.trim(),
      };
      saveSettingsData(data);
      closeSettings();
      // Refresh current view
      if (currentTab === 'monitor') loadMonitorView();
      if (currentTab === 'profile') loadProfileView();
    }
    
    function clearApiKeys() {
      if (confirm('Clear all API keys?')) {
        const settings = getSettings();
        settings.githubToken = '';
        settings.pagespeedKey = '';
        settings.geminiKey = '';
        saveSettingsData(settings);
        document.getElementById('github-token-input').value = '';
        document.getElementById('pagespeed-key-input').value = '';
        document.getElementById('gemini-key-input').value = '';
      }
    }
    
    function loadSettings() {
      // Pre-load settings on init (no UI action needed)
    }

    // --- Navigation ---
    function switchTab(tab) {
      currentTab = tab;
      
      document.querySelectorAll('#nav-links button').forEach(btn => btn.classList.remove('active'));
      const activeBtn = document.querySelector(`button[onclick="switchTab('${tab}')"]`);
      if(activeBtn) activeBtn.classList.add('active');

      if (tab === 'dashboard') loadDashboard();
      if (tab === 'profile') loadProfileView();
      if (tab === 'quality') loadQualityView();
      if (tab === 'monitor') loadMonitorView();
      if (tab === 'pagespeed') loadPageSpeedView();
      if (tab === 'git') loadGitView();
      if (tab === 'reports') loadReportsView();
      if (tab === 'logs') loadLogsView();
    }

    // --- Views ---

    async function loadDashboard() {
      const container = document.getElementById('content-area');
      container.innerHTML = '<div class="text-muted animate-pulse">Loading dashboard...</div>';

      try {
        const res = await fetch(`${API_BASE}/reports/quality`);
        const json = await res.json();
        const reports = json.data || [];
        const latest = reports.length > 0 ? reports[0].data : null;
        
        const scores = { build: 0, render: 0, ux: 0, a11y: 0, seo: 0 };
        if (latest && latest.scores) {
          scores.build = Math.round(latest.scores.build || 0);
          scores.render = Math.round(latest.scores.render || 0);
          scores.ux = Math.round(latest.scores.ux || 0);
          scores.a11y = Math.round(latest.scores.a11y || 0);
          scores.seo = Math.round(latest.scores.seo || 0);
        }

        const getColor = (s) => s >= 90 ? 'text-success' : (s >= 50 ? 'text-warning' : 'text-error');
        const getBg = (s) => s >= 90 ? 'bg-success' : (s >= 50 ? 'bg-warning' : 'bg-error');

        container.innerHTML = `
          <header class="flex justify-between items-end mb-8">
            <div>
              <h1 class="text-3xl font-bold text-white mb-2">Dashboard</h1>
              <p class="text-muted text-sm">Quality Core metrics overview</p>
            </div>
            <div class="flex gap-2">
              <button onclick="loadDashboard()" class="px-4 py-2 bg-white/5 text-muted rounded-lg hover:bg-white/10 transition text-sm">‚Üª Refresh</button>
            </div>
          </header>
          
          <!-- Score Cards -->
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
            ${renderScoreCard('Build', scores.build, 'üì¶', getColor(scores.build), getBg(scores.build))}
            ${renderScoreCard('Render', scores.render, 'üöÄ', getColor(scores.render), getBg(scores.render))}
            ${renderScoreCard('UX', scores.ux, 'üëÜ', getColor(scores.ux), getBg(scores.ux))}
            ${renderScoreCard('A11y', scores.a11y, '‚ôø', getColor(scores.a11y), getBg(scores.a11y))}
            ${renderScoreCard('SEO', scores.seo, 'üîç', getColor(scores.seo), getBg(scores.seo))}
          </div>

          <!-- Trend Chart -->
          <div class="glass-card p-6 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-4">
              <div>
                <h3 class="text-sm font-medium text-muted uppercase tracking-widest">Score Trend</h3>
                <p class="text-xs text-muted mt-1" id="chart-site-name">${getSettings().projectName || getSettings().monitorUrl || 'Local Project'}</p>
              </div>
              <div class="flex gap-2 items-center">
                <div id="period-filters" class="flex flex-wrap gap-1 bg-surfaceHighlight/50 p-1 rounded-lg">
                  <button onclick="setPeriodFilter('1h')" class="period-btn px-2 py-1 text-xs font-medium rounded transition-all text-muted hover:text-white" data-period="1h">1h</button>
                  <button onclick="setPeriodFilter('6h')" class="period-btn px-2 py-1 text-xs font-medium rounded transition-all text-muted hover:text-white" data-period="6h">6h</button>
                  <button onclick="setPeriodFilter('12h')" class="period-btn px-2 py-1 text-xs font-medium rounded transition-all text-muted hover:text-white" data-period="12h">12h</button>
                  <button onclick="setPeriodFilter('24h')" class="period-btn px-2 py-1 text-xs font-medium rounded transition-all bg-primary text-black" data-period="24h">24h</button>
                  <button onclick="setPeriodFilter('7d')" class="period-btn px-2 py-1 text-xs font-medium rounded transition-all text-muted hover:text-white" data-period="7d">7d</button>
                  <button onclick="setPeriodFilter('30d')" class="period-btn px-2 py-1 text-xs font-medium rounded transition-all text-muted hover:text-white" data-period="30d">30d</button>
                  <button onclick="setPeriodFilter('6m')" class="period-btn px-2 py-1 text-xs font-medium rounded transition-all text-muted hover:text-white" data-period="6m">6m</button>
                  <button onclick="setPeriodFilter('12m')" class="period-btn px-2 py-1 text-xs font-medium rounded transition-all text-muted hover:text-white" data-period="12m">12m</button>
                  <button onclick="setPeriodFilter('all')" class="period-btn px-2 py-1 text-xs font-medium rounded transition-all text-muted hover:text-white" data-period="all">All</button>
                </div>
                <button onclick="exportChartSVG()" class="px-3 py-1 text-xs font-medium bg-surfaceHighlight text-muted rounded hover:text-white transition" title="Save as SVG">üìä SVG</button>
              </div>
            </div>
            <div class="relative w-full" style="height: 280px; max-height: 40vh;">
              <canvas id="trend-chart" class="absolute inset-0 w-full h-full"></canvas>
            </div>
          </div>

          <!-- Recent Scans & Quick Stats -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-card p-6">
              <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">üõ°Ô∏è Recent Scans</h3>
              <div class="space-y-2" id="recent-scans-list">
                ${renderRecentScans(reports)}
              </div>
            </div>
            
            <div class="glass-card p-6">
              <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">üìä Quick Stats</h3>
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-surfaceHighlight/50 p-4 rounded-lg">
                  <div class="text-2xl font-mono font-bold text-white">${reports.length}</div>
                  <div class="text-xs text-muted">Total Scans</div>
                </div>
                <div class="bg-surfaceHighlight/50 p-4 rounded-lg">
                  <div class="text-2xl font-mono font-bold ${latest?.status === 'pass' ? 'text-success' : 'text-error'}">${latest?.status === 'pass' ? '‚úì' : '‚úó'}</div>
                  <div class="text-xs text-muted">Last Status</div>
                </div>
              </div>
            </div>
          </div>
        `;

        // Render chart
        renderTrendChart(reports, '24h');

      } catch (err) {
        container.innerHTML = `<div class="p-4 bg-error/10 text-error rounded">Failed to load dashboard: ${err.message}</div>`;
      }
    }

    function renderScoreCard(title, score, icon, colorClass, bgClass) {
      return `
        <div class="glass-card p-4 relative group overflow-hidden">
          <div class="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition text-4xl pointer-events-none">${icon}</div>
          <div class="text-xs text-muted uppercase tracking-wider mb-1">${title}</div>
          <div class="text-3xl font-bold font-mono ${colorClass}">${score}</div>
          <div class="w-full bg-white/5 h-1 mt-3 rounded-full overflow-hidden">
            <div class="h-full ${bgClass} transition-all duration-1000" style="width: ${score}%"></div>
          </div>
        </div>`;
    }

    function renderRecentScans(reports) {
      if (!reports || reports.length === 0) return '<div class="text-muted text-sm italic">No scans yet</div>';
      return reports.slice(0, 5).map(r => `
        <div class="flex items-center justify-between p-3 bg-surfaceHighlight/50 rounded-lg hover:bg-surfaceHighlight transition cursor-pointer" onclick="viewQualityReport('${r.filename}')">
          <div class="flex items-center gap-3">
            <div class="w-2 h-2 rounded-full ${r.data?.status === 'pass' ? 'bg-success' : 'bg-error'}"></div>
            <div>
              <div class="text-sm font-medium text-white">${r.filename.replace('.json', '')}</div>
              <div class="text-xs text-muted">${new Date(r.timestamp).toLocaleString()}</div>
            </div>
          </div>
          <span class="text-xs ${r.data?.status === 'pass' ? 'text-success' : 'text-error'}">${r.data?.status === 'pass' ? 'PASS' : 'FAIL'}</span>
        </div>
      `).join('');
    }

    let currentPeriod = '24h';
    function setPeriodFilter(period) {
      currentPeriod = period;
      document.querySelectorAll('.period-btn').forEach(btn => {
        if (btn.dataset.period === period) {
          btn.classList.add('bg-primary', 'text-black');
          btn.classList.remove('text-muted');
        } else {
          btn.classList.remove('bg-primary', 'text-black');
          btn.classList.add('text-muted');
        }
      });
      // Re-fetch and re-render chart
      fetch(`${API_BASE}/reports/quality`).then(r => r.json()).then(json => {
        renderTrendChart(json.data || [], period);
      });
    }

    function renderTrendChart(reports, period) {
      const canvas = document.getElementById('trend-chart');
      if (!canvas) return;
      const settings = getSettings();
      
      const now = Date.now();
      const siteName = settings.projectName || settings.monitorUrl || 'Local Project';
      
      // Period configuration: intervals, intervalMs, labelFormat, and periodMs
      const periodConfig = {
        '1h':   { intervals: 12,  ms: 1*60*60*1000,       intervalDiv: 12,  label: d => `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}` },
        '6h':   { intervals: 12,  ms: 6*60*60*1000,       intervalDiv: 12,  label: d => `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}` },
        '12h':  { intervals: 24,  ms: 12*60*60*1000,      intervalDiv: 24,  label: d => `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}` },
        '24h':  { intervals: 24,  ms: 24*60*60*1000,      intervalDiv: 24,  label: d => `${d.getHours()}h` },
        '7d':   { intervals: 28,  ms: 7*24*60*60*1000,    intervalDiv: 28,  label: d => `${d.getDate()}/${d.getMonth()+1}` },
        '30d':  { intervals: 30,  ms: 30*24*60*60*1000,   intervalDiv: 30,  label: d => `${d.getDate()}/${d.getMonth()+1}` },
        '6m':   { intervals: 26,  ms: 180*24*60*60*1000,  intervalDiv: 26,  label: d => `${d.getDate()}/${d.getMonth()+1}` },
        '12m':  { intervals: 12,  ms: 365*24*60*60*1000,  intervalDiv: 12,  label: d => `${d.toLocaleString('default', {month:'short'})}` },
        'all':  { intervals: 30,  ms: Infinity,          intervalDiv: 30,  label: d => `${d.getDate()}/${d.getMonth()+1}` }
      };
      
      const config = periodConfig[period] || periodConfig['24h'];
      const intervals = config.intervals;
      const periodMs = config.ms;
      const intervalMs = periodMs === Infinity ? 
        (reports.length > 1 ? (now - new Date(reports[reports.length-1]?.timestamp).getTime()) / intervals : 24*60*60*1000) :
        periodMs / intervals;
      const labelFormat = config.label;
      const cutoff = periodMs === Infinity ? 0 : now - periodMs;
      
      // Generate labels for timeline
      const labels = [];
      const buildData = [];
      const renderData = [];
      
      for (let i = intervals - 1; i >= 0; i--) {
        const time = now - (i * intervalMs);
        const d = new Date(time);
        labels.push(labelFormat(d));
        
        // Find closest data point within this interval
        const intervalStart = time - intervalMs / 2;
        const intervalEnd = time + intervalMs / 2;
        
        const matchingReports = reports.filter(r => {
          const t = new Date(r.timestamp).getTime();
          return t >= intervalStart && t < intervalEnd && t > cutoff;
        });
        
        if (matchingReports.length > 0) {
          // Average values for this interval
          const avgBuild = matchingReports.reduce((sum, r) => sum + (r.data?.scores?.build || 0), 0) / matchingReports.length;
          const avgRender = matchingReports.reduce((sum, r) => sum + (r.data?.scores?.render || 0), 0) / matchingReports.length;
          buildData.push(Math.round(avgBuild));
          renderData.push(Math.round(avgRender));
        } else {
          buildData.push(null); // null creates gaps in chart
          renderData.push(null);
        }
      }
      
      if (trendChart) trendChart.destroy();
      
      trendChart = new Chart(canvas, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Build', data: buildData, borderColor: '#22d3ee', backgroundColor: 'rgba(34, 211, 238, 0.1)', fill: true, tension: 0.3, pointRadius: 3, spanGaps: true },
            { label: 'Render', data: renderData, borderColor: '#f59e0b', backgroundColor: 'transparent', tension: 0.3, pointRadius: 3, spanGaps: true },
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: true, position: 'top', labels: { color: '#a3a3a3', font: { size: 11 } } },
            title: { display: true, text: `${siteName} - ${period.toUpperCase()}`, color: '#666', font: { size: 12 } }
          },
          scales: {
            x: { 
              grid: { color: 'rgba(255,255,255,0.03)' }, 
              ticks: { color: '#666', maxRotation: 45, font: { size: 9 } } 
            },
            y: { min: 0, max: 100, grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#666' } }
          }
        }
      });
    }

    function exportChartSVG() {
      const canvas = document.getElementById('trend-chart');
      if (!canvas) return;
      
      // Convert canvas to SVG-like format
      const dataUrl = canvas.toDataURL('image/png');
      const settings = getSettings();
      const siteName = (settings.projectName || 'chart').replace(/[^a-z0-9]/gi, '-');
      
      // Create an SVG wrapper with the canvas image
      const width = canvas.width;
      const height = canvas.height;
      const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="${width}" height="${height}">
  <image width="${width}" height="${height}" xlink:href="${dataUrl}"/>
</svg>`;
      
      const blob = new Blob([svg], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `score-trend-${siteName}-${currentPeriod}.svg`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // --- Monitor View ---
    let monitorChart = null;
    let pingHistory = JSON.parse(localStorage.getItem('pingHistory') || '[]');
    let monitorPeriod = '1h';

    async function loadMonitorView() {
      const container = document.getElementById('content-area');
      const settings = getSettings();
      
      if (!settings.monitorUrl) {
        container.innerHTML = `
          <div class="glass-card p-8 text-center">
            <div class="text-4xl mb-4">üîß</div>
            <h3 class="text-lg font-bold text-white mb-2">No Site Configured</h3>
            <p class="text-muted mb-4">Add your GitHub Pages URL in Settings to start monitoring.</p>
            <button onclick="openSettings()" class="px-6 py-3 bg-primary text-black font-bold rounded-lg">Open Settings</button>
          </div>
        `;
        return;
      }
      
      // Calculate stats from history
      const recentPings = pingHistory.filter(p => p.url === settings.monitorUrl);
      const latencies = recentPings.map(p => p.latency).filter(l => l > 0);
      const avgLatency = latencies.length > 0 ? Math.round(latencies.reduce((a, b) => a + b, 0) / latencies.length) : 0;
      const minLatency = latencies.length > 0 ? Math.min(...latencies) : 0;
      const maxLatency = latencies.length > 0 ? Math.max(...latencies) : 0;
      const uptime = recentPings.length > 0 ? Math.round((recentPings.filter(p => p.ok).length / recentPings.length) * 100) : 0;
      
      container.innerHTML = `
        <!-- Header -->
        <div class="flex flex-wrap items-center justify-between gap-3 mb-6 pb-3 border-b border-white/10">
          <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold text-white">üì° Site Monitor</h1>
            <span class="text-xs text-muted font-mono">${settings.monitorUrl}</span>
          </div>
          <button onclick="pingMonitoredSite()" class="px-3 py-1 bg-primary/10 text-primary border border-primary/50 rounded text-xs font-bold hover:bg-primary hover:text-black transition">
            <span class="animate-pulse">‚óè</span> Ping Now
          </button>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
          <div class="glass-card p-4 text-center">
            <div id="current-status" class="flex items-center justify-center gap-2 text-lg font-bold text-muted">
              <div class="w-3 h-3 rounded-full bg-muted animate-pulse"></div>
              Checking
            </div>
            <div class="text-xs text-muted">Status</div>
          </div>
          <div class="glass-card p-4 text-center">
            <div id="current-latency" class="text-2xl font-bold font-mono text-white">--</div>
            <div class="text-xs text-muted">Current (ms)</div>
          </div>
          <div class="glass-card p-4 text-center">
            <div class="text-2xl font-bold font-mono text-white">${avgLatency}</div>
            <div class="text-xs text-muted">Avg (ms)</div>
          </div>
          <div class="glass-card p-4 text-center">
            <div class="text-2xl font-bold font-mono text-muted">${minLatency} / ${maxLatency}</div>
            <div class="text-xs text-muted">Min / Max (ms)</div>
          </div>
          <div class="glass-card p-4 text-center">
            <div class="text-2xl font-bold font-mono ${uptime >= 95 ? 'text-success' : (uptime >= 80 ? 'text-warning' : 'text-error')}">${uptime}%</div>
            <div class="text-xs text-muted">Uptime</div>
          </div>
        </div>

        <!-- Latency Chart -->
        <div class="glass-card p-6 mb-6">
          <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
            <h3 class="text-sm font-medium text-muted uppercase tracking-widest">üìà Response Time History</h3>
            <div class="flex gap-2 items-center">
              <div class="flex gap-1 bg-surfaceHighlight/50 p-1 rounded-lg">
                <button onclick="setMonitorPeriod('1h')" class="monitor-period-btn px-3 py-1 text-xs font-medium rounded transition-all ${monitorPeriod === '1h' ? 'bg-primary text-black' : 'text-muted hover:text-white'}" data-period="1h">1h</button>
                <button onclick="setMonitorPeriod('12h')" class="monitor-period-btn px-3 py-1 text-xs font-medium rounded transition-all ${monitorPeriod === '12h' ? 'bg-primary text-black' : 'text-muted hover:text-white'}" data-period="12h">12h</button>
                <button onclick="setMonitorPeriod('24h')" class="monitor-period-btn px-3 py-1 text-xs font-medium rounded transition-all ${monitorPeriod === '24h' ? 'bg-primary text-black' : 'text-muted hover:text-white'}" data-period="24h">24h</button>
              </div>
              <button onclick="exportMonitorChartSVG()" class="px-2 py-1 text-xs bg-surfaceHighlight text-muted rounded hover:text-white">üíæ SVG</button>
            </div>
          </div>
          <div class="h-48">
            <canvas id="monitor-chart"></canvas>
          </div>
        </div>

        <!-- GitHub Status -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="glass-card p-6">
            <h3 class="text-sm font-medium text-muted uppercase tracking-widest mb-4">üöÄ GitHub Actions</h3>
            <div id="actions-status">
              ${settings.githubToken && settings.githubRepo ? '<div class="text-muted">Loading...</div>' : '<div class="text-muted text-sm">Configure GitHub token in Settings</div>'}
            </div>
          </div>
          <div class="glass-card p-6">
            <h3 class="text-sm font-medium text-muted uppercase tracking-widest mb-4">üìù Recent Commits</h3>
            <div id="commits-list" class="space-y-2 max-h-40 overflow-y-auto">
              ${settings.githubToken && settings.githubRepo ? '<div class="text-muted">Loading...</div>' : '<div class="text-muted text-sm">Configure GitHub token and repo</div>'}
            </div>
          </div>
        </div>
      `;

      // Initial ping and load data
      pingMonitoredSite();
      renderMonitorChart();
      if (settings.githubToken && settings.githubRepo) {
        loadGitHubStatus();
      }
    }

    function setMonitorPeriod(period) {
      monitorPeriod = period;
      document.querySelectorAll('.monitor-period-btn').forEach(btn => {
        if (btn.dataset.period === period) {
          btn.classList.add('bg-primary', 'text-black');
          btn.classList.remove('text-muted');
        } else {
          btn.classList.remove('bg-primary', 'text-black');
          btn.classList.add('text-muted');
        }
      });
      renderMonitorChart();
    }

    function renderMonitorChart() {
      const canvas = document.getElementById('monitor-chart');
      if (!canvas) return;
      
      const settings = getSettings();
      const now = Date.now();
      const periodMs = { '1h': 60*60*1000, '12h': 12*60*60*1000, '24h': 24*60*60*1000 };
      const cutoff = now - (periodMs[monitorPeriod] || periodMs['1h']);
      
      const filtered = pingHistory
        .filter(p => p.url === settings.monitorUrl && p.timestamp > cutoff)
        .sort((a, b) => a.timestamp - b.timestamp);
      
      const labels = filtered.map(p => {
        const d = new Date(p.timestamp);
        return `${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
      });
      
      const data = filtered.map(p => p.latency);
      
      if (monitorChart) monitorChart.destroy();
      
      monitorChart = new Chart(canvas, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Response Time (ms)',
            data,
            borderColor: '#22d3ee',
            backgroundColor: 'rgba(34, 211, 238, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 2,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { display: true, text: `${settings.projectName || 'Site'} - ${monitorPeriod.toUpperCase()}`, color: '#666', font: { size: 11 } }
          },
          scales: {
            x: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#666', font: { size: 9 }, maxRotation: 45 } },
            y: { min: 0, grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#666' } }
          }
        }
      });
    }

    function exportMonitorChartSVG() {
      const canvas = document.getElementById('monitor-chart');
      if (!canvas) return;
      
      const dataUrl = canvas.toDataURL('image/png');
      const settings = getSettings();
      const siteName = (settings.projectName || 'monitor').replace(/[^a-z0-9]/gi, '-');
      
      const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="${canvas.width}" height="${canvas.height}">
  <image width="${canvas.width}" height="${canvas.height}" xlink:href="${dataUrl}"/>
</svg>`;
      
      const blob = new Blob([svg], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `monitor-${siteName}-${monitorPeriod}.svg`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function pingMonitoredSite() {
      const settings = getSettings();
      if (!settings.monitorUrl) return;
      
      const statusEl = document.getElementById('current-status');
      const latencyEl = document.getElementById('current-latency');
      
      if (statusEl) {
        statusEl.innerHTML = `<div class="w-3 h-3 rounded-full bg-warning animate-pulse"></div><span class="text-warning">Pinging</span>`;
      }
      
      const start = Date.now();
      try {
        // Use image ping technique (works cross-origin)
        await new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = resolve;
          img.onerror = resolve; // Even error means server responded
          img.src = settings.monitorUrl + '/favicon.ico?' + Date.now();
          setTimeout(() => reject(new Error('Timeout')), 10000);
        });
        
        const latency = Date.now() - start;
        const status = latency < 1000 ? 'online' : 'slow';
        const color = status === 'online' ? 'success' : 'warning';
        
        // Save to history
        pingHistory.push({
          url: settings.monitorUrl,
          timestamp: Date.now(),
          latency,
          ok: true
        });
        // Keep last 500 pings
        if (pingHistory.length > 500) pingHistory = pingHistory.slice(-500);
        localStorage.setItem('pingHistory', JSON.stringify(pingHistory));
        
        if (statusEl) {
          statusEl.innerHTML = `<div class="w-3 h-3 rounded-full bg-${color}"></div><span class="text-${color}">${status === 'online' ? 'Online' : 'Slow'}</span>`;
        }
        if (latencyEl) {
          latencyEl.textContent = latency;
          latencyEl.className = `text-2xl font-bold font-mono text-${color}`;
        }
        
        // Update chart
        renderMonitorChart();
        
      } catch (e) {
        // Save failed ping
        pingHistory.push({
          url: settings.monitorUrl,
          timestamp: Date.now(),
          latency: 0,
          ok: false
        });
        if (pingHistory.length > 500) pingHistory = pingHistory.slice(-500);
        localStorage.setItem('pingHistory', JSON.stringify(pingHistory));
        
        if (statusEl) {
          statusEl.innerHTML = `<div class="w-3 h-3 rounded-full bg-error"></div><span class="text-error">Offline</span>`;
        }
        if (latencyEl) {
          latencyEl.textContent = '--';
          latencyEl.className = 'text-2xl font-bold font-mono text-error';
        }
      }
    }

    async function loadGitHubStatus() {
      const settings = getSettings();
      if (!settings.githubToken || !settings.githubRepo) return;
      
      const [owner, repo] = settings.githubRepo.split('/');
      if (!owner || !repo) return;
      
      try {
        // Fetch latest workflow runs
        const runsRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs?per_page=5`, {
          headers: { Authorization: `token ${settings.githubToken}` }
        });
        const runsData = await runsRes.json();
        
        const actionsEl = document.getElementById('actions-status');
        if (runsData.workflow_runs && runsData.workflow_runs.length > 0) {
          const latest = runsData.workflow_runs[0];
          const color = latest.conclusion === 'success' ? 'success' : (latest.conclusion === 'failure' ? 'error' : 'warning');
          actionsEl.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="w-3 h-3 rounded-full bg-${color}"></div>
              <div>
                <div class="text-sm font-medium text-white">${latest.name}</div>
                <div class="text-xs text-muted">${latest.conclusion || 'Running'}</div>
              </div>
            </div>`;
        }

        // Fetch commits
        const commitsRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/commits?per_page=5`, {
          headers: { Authorization: `token ${settings.githubToken}` }
        });
        const commitsData = await commitsRes.json();
        
        const commitsEl = document.getElementById('commits-list');
        if (Array.isArray(commitsData) && commitsData.length > 0) {
          commitsEl.innerHTML = commitsData.map(c => `
            <a href="${c.html_url}" target="_blank" rel="noopener" class="flex items-center gap-3 p-2 rounded hover:bg-surfaceHighlight/50 transition">
              <span class="font-mono text-xs text-primary">${c.sha.slice(0, 7)}</span>
              <span class="text-sm text-white truncate flex-1">${c.commit.message.split('\n')[0]}</span>
              <span class="text-xs text-muted">${new Date(c.commit.author.date).toLocaleDateString()}</span>
            </a>
          `).join('');
        }
        
      } catch (e) {
        console.error('GitHub API error:', e);
      }
    }

    // --- Quality View ---
    async function loadQualityView() {
      const container = document.getElementById('content-area');
      container.innerHTML = `
        <h1 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
          <span>üõ°Ô∏è</span> Quality Scans 
          <button onclick="runCommand('quality')" class="text-xs bg-primary/10 text-primary px-3 py-1 rounded hover:bg-primary/20 transition">New Scan</button>
        </h1>
        <div class="grid grid-cols-1 gap-4" id="quality-grid">
          <div class="text-muted animate-pulse">Loading scans...</div>
        </div>
      `;
      
      try {
        const res = await fetch(`${API_BASE}/reports/quality`);
        const json = await res.json();
        const grid = document.getElementById('quality-grid');
        
        if(!json.data || json.data.length === 0) {
          grid.innerHTML = '<div class="p-8 text-center text-muted border border-dashed border-white/10 rounded-xl">No scans found.</div>';
          return;
        }

        grid.innerHTML = json.data.map(r => {
          const s = r.data?.scores || {};
          return `
            <div class="glass-card p-6 flex flex-col md:flex-row justify-between items-center gap-4 hover:border-primary/30 transition cursor-pointer" onclick="viewQualityReport('${r.filename}')">
              <div class="flex items-center gap-4">
                <div class="p-3 bg-surfaceHighlight rounded-lg text-2xl">${r.data?.status === 'pass' ? '‚úÖ' : '‚ùå'}</div>
                <div>
                  <div class="font-mono text-sm text-white mb-1">${r.filename}</div>
                  <div class="text-xs text-muted">${new Date(r.timestamp).toLocaleString()}</div>
                </div>
              </div>
              <div class="flex gap-4">
                ${renderMiniScore('Build', s.build)}
                ${renderMiniScore('Render', s.render)}
                ${renderMiniScore('UX', s.ux)}
                ${renderMiniScore('A11y', s.a11y)}
              </div>
            </div>`;
        }).join('');
      } catch(e) {
        document.getElementById('quality-grid').innerHTML = 'Error loading scans.';
      }
    }

    function renderMiniScore(label, value) {
      const s = Math.round(value || 0);
      const color = s >= 90 ? 'text-success' : (s >= 50 ? 'text-warning' : 'text-error');
      return `<div class="text-center"><div class="text-xs text-muted mb-1">${label}</div><div class="font-mono font-bold ${color}">${s}</div></div>`;
    }

    async function viewQualityReport(filename) {
      const res = await fetch(`${API_BASE}/report/quality/${filename}`);
      const json = await res.json();
      const container = document.getElementById('content-area');
      const d = json.data;

      const violationsHtml = (d.violations || []).map(v => `
        <div class="flex justify-between items-start p-3 bg-white/5 rounded border-l-2 ${v.severity === 'error' ? 'border-error' : 'border-warning'} mb-2">
          <div>
            <div class="text-sm font-bold text-white">[${(v.area || '').toUpperCase()}] ${v.metric}</div>
            <div class="text-xs text-muted">Value: ${v.value} | Threshold: ${v.threshold}</div>
          </div>
          <span class="text-xs uppercase px-2 py-1 rounded bg-black/20 ${v.severity === 'error' ? 'text-error' : 'text-warning'}">${v.severity}</span>
        </div>
      `).join('');
      
      container.innerHTML = `
        <button onclick="switchTab('quality')" class="mb-4 text-sm text-muted hover:text-white flex items-center gap-2">‚Üê Back to Scans</button>
        <div class="glass-card p-6 overflow-auto">
          <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
            <h2 class="text-xl font-bold text-white">Scan Result: ${(d.status || '').toUpperCase()}</h2>
            <span class="font-mono text-xs text-muted">${d.meta?.timestamp ? new Date(d.meta.timestamp).toLocaleString() : ''}</span>
          </div>
          
          <div class="mb-6">
            <h3 class="text-sm font-bold text-muted uppercase mb-3">Violations (${(d.violations || []).length})</h3>
            ${(d.violations || []).length > 0 ? violationsHtml : '<div class="text-success text-sm">No violations found! üéâ</div>'}
          </div>

          <div>
            <h3 class="text-sm font-bold text-muted uppercase mb-3">Raw Data</h3>
            <pre class="text-xs text-muted font-mono bg-black/20 p-4 rounded overflow-x-auto">${JSON.stringify(d.raw || d, null, 2)}</pre>
          </div>
        </div>
      `;
    }

    // --- Lighthouse View ---
    async function loadReportsView() {
      const container = document.getElementById('content-area');
      container.innerHTML = `
        <h1 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
          <span>üî¶</span> Lighthouse Reports 
          <button onclick="runCommand('lighthouse')" class="text-xs bg-primary/10 text-primary px-3 py-1 rounded hover:bg-primary/20 transition">New Scan</button>
        </h1>
        <div class="grid grid-cols-1 gap-4" id="reports-grid">
          <div class="text-muted animate-pulse">Loading reports...</div>
        </div>
      `;
      
      const res = await fetch(`${API_BASE}/reports/lighthouse`);
      const json = await res.json();
      
      const grid = document.getElementById('reports-grid');
      if(!json.data || json.data.length === 0) {
        grid.innerHTML = '<div class="p-8 text-center text-muted border border-dashed border-white/10 rounded-xl">No reports found.</div>';
        return;
      }

      grid.innerHTML = json.data.map(r => {
        const cats = r.data?.categories || {};
        return `
          <div class="glass-card p-6 flex flex-col md:flex-row justify-between items-center gap-4 hover:border-primary/30 transition cursor-pointer" onclick="viewReport('${r.filename}')">
            <div class="flex items-center gap-4">
              <div class="p-3 bg-surfaceHighlight rounded-lg text-2xl">üì±</div>
              <div>
                <div class="font-mono text-sm text-white mb-1">${r.filename}</div>
                <div class="text-xs text-muted">${new Date(r.timestamp).toLocaleString()}</div>
              </div>
            </div>
            <div class="flex gap-6">
              ${renderMiniScore('Perf', (cats.performance?.score || 0) * 100)}
              ${renderMiniScore('A11y', (cats.accessibility?.score || 0) * 100)}
              ${renderMiniScore('SEO', (cats.seo?.score || 0) * 100)}
            </div>
          </div>`;
      }).join('');
    }

    async function viewReport(filename) {
      const res = await fetch(`${API_BASE}/report/lighthouse/${filename}`);
      const json = await res.json();
      const container = document.getElementById('content-area');
      const report = json.data;
      const settings = getSettings();
      
      if (!report || !report.categories) {
        container.innerHTML = `
          <button onclick="switchTab('reports')" class="mb-4 text-sm text-muted hover:text-white flex items-center gap-2">‚Üê Back to Reports</button>
          <div class="glass-card p-6 text-error">Invalid report format</div>
        `;
        return;
      }
      
      const cats = report.categories;
      const audits = report.audits || {};
      const getColor = (s) => s >= 90 ? 'text-success' : (s >= 50 ? 'text-warning' : 'text-error');
      const getBg = (s) => s >= 90 ? 'bg-success' : (s >= 50 ? 'bg-warning' : 'bg-error');
      
      // Failed audits
      const failedAudits = Object.values(audits)
        .filter(a => a.score !== null && a.score < 0.9 && a.scoreDisplayMode === 'binary')
        .sort((a, b) => (a.score || 0) - (b.score || 0))
        .slice(0, 10);
      
      // Check for saved AI analysis
      const analysisKey = `lh_analysis_${filename}`;
      const savedAnalysis = localStorage.getItem(analysisKey);
      
      container.innerHTML = `
        <button onclick="switchTab('reports')" class="mb-4 text-sm text-muted hover:text-white flex items-center gap-2">‚Üê Back to Reports</button>
        
        <!-- Header Summary -->
        <div class="glass-card p-6 mb-6">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
            <div>
              <h2 class="text-xl font-bold text-white mb-1">üì± ${filename}</h2>
              <p class="text-muted text-sm">${report.finalUrl || 'N/A'} ‚Ä¢ ${new Date(report.fetchTime).toLocaleString()}</p>
            </div>
            <div class="flex gap-2">
              <button onclick="openReportConsole('${filename}')" class="px-3 py-2 bg-surfaceHighlight text-muted rounded-lg hover:bg-white/10 transition text-sm">üìã Raw JSON</button>
              <button onclick="exportReportMarkdown('${filename}')" class="px-3 py-2 bg-surfaceHighlight text-muted rounded-lg hover:bg-white/10 transition text-sm">üíæ Export MD</button>
              ${settings.geminiKey ? `<button onclick="analyzeWithGemini('${filename}')" class="px-3 py-2 bg-purple-500/20 text-purple-400 rounded-lg hover:bg-purple-500/30 transition text-sm">‚ú® AI Analysis</button>` : ''}
            </div>
          </div>
          
          <!-- Scores Grid -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            ${['performance', 'accessibility', 'best-practices', 'seo'].map(cat => {
              const score = Math.round((cats[cat]?.score || 0) * 100);
              return `
                <div class="bg-surfaceHighlight/50 p-4 rounded-lg text-center">
                  <div class="text-3xl font-bold font-mono ${getColor(score)}">${score}</div>
                  <div class="text-xs text-muted uppercase mt-1">${cat.replace('-', ' ')}</div>
                  <div class="w-full bg-white/5 h-1.5 mt-2 rounded-full overflow-hidden">
                    <div class="h-full ${getBg(score)} transition-all duration-500" style="width: ${score}%"></div>
                  </div>
                </div>`;
            }).join('')}
          </div>
        </div>
        
        <!-- Core Web Vitals -->
        <div class="glass-card p-6 mb-6">
          <h3 class="text-sm font-medium text-muted uppercase tracking-widest mb-4">‚ö° Core Web Vitals</h3>
          <div class="grid grid-cols-3 md:grid-cols-6 gap-4 text-center">
            <div><div class="text-lg font-mono font-bold text-white">${audits['largest-contentful-paint']?.displayValue || '-'}</div><div class="text-xs text-muted">LCP</div></div>
            <div><div class="text-lg font-mono font-bold text-white">${audits['first-contentful-paint']?.displayValue || '-'}</div><div class="text-xs text-muted">FCP</div></div>
            <div><div class="text-lg font-mono font-bold text-white">${audits['cumulative-layout-shift']?.displayValue || '-'}</div><div class="text-xs text-muted">CLS</div></div>
            <div><div class="text-lg font-mono font-bold text-white">${audits['total-blocking-time']?.displayValue || '-'}</div><div class="text-xs text-muted">TBT</div></div>
            <div><div class="text-lg font-mono font-bold text-white">${audits['speed-index']?.displayValue || '-'}</div><div class="text-xs text-muted">SI</div></div>
            <div><div class="text-lg font-mono font-bold text-white">${audits['interactive']?.displayValue || '-'}</div><div class="text-xs text-muted">TTI</div></div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Failed Audits -->
          <div class="glass-card p-6">
            <h3 class="text-sm font-medium text-muted uppercase tracking-widest mb-4">‚ö†Ô∏è Attention Points (${failedAudits.length})</h3>
            ${failedAudits.length > 0 ? `
              <div class="space-y-2 max-h-80 overflow-y-auto">
                ${failedAudits.map(a => `
                  <div class="p-3 bg-surfaceHighlight/50 rounded-lg border-l-2 border-warning">
                    <div class="text-sm font-medium text-white">${a.title}</div>
                    <div class="text-xs text-muted mt-1">${a.description?.substring(0, 150) || ''}...</div>
                  </div>
                `).join('')}
              </div>
            ` : '<div class="text-success text-sm">All audits passed! üéâ</div>'}
          </div>
          
          <!-- AI Analysis -->
          <div class="glass-card p-6">
            <h3 class="text-sm font-medium text-muted uppercase tracking-widest mb-4">ü§ñ AI Analysis</h3>
            <div id="ai-analysis-content" class="prose max-w-none text-sm">
              ${savedAnalysis ? marked.parse(savedAnalysis) : `
                <div class="text-muted text-center py-8">
                  ${settings.geminiKey ? 'Click "‚ú® AI Analysis" to generate insights' : 'Configure Gemini API key in Settings'}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
      
      // Store current report for analysis
      window.currentLighthouseReport = { filename, data: report };
    }

    async function analyzeWithGemini(filename) {
      const settings = getSettings();
      if (!settings.geminiKey) {
        alert('Gemini API key not configured');
        return;
      }
      
      const report = window.currentLighthouseReport?.data;
      if (!report) return;
      
      const analysisEl = document.getElementById('ai-analysis-content');
      analysisEl.innerHTML = '<div class="text-muted animate-pulse">üîÑ Generating AI analysis...</div>';
      
      try {
        const cats = report.categories;
        const audits = report.audits;
        
        // Build prompt with key data
        const prompt = `Analyze this Lighthouse report and provide technical recommendations in Portuguese (pt-BR). Be concise but technical.

URL: ${report.finalUrl}
Device: ${report.configSettings?.formFactor || 'unknown'}

SCORES:
- Performance: ${Math.round((cats.performance?.score || 0) * 100)}%
- Accessibility: ${Math.round((cats.accessibility?.score || 0) * 100)}%
- Best Practices: ${Math.round((cats['best-practices']?.score || 0) * 100)}%
- SEO: ${Math.round((cats.seo?.score || 0) * 100)}%

CORE WEB VITALS:
- LCP: ${audits['largest-contentful-paint']?.numericValue}ms
- FCP: ${audits['first-contentful-paint']?.numericValue}ms
- CLS: ${audits['cumulative-layout-shift']?.numericValue}
- TBT: ${audits['total-blocking-time']?.numericValue}ms

FAILED AUDITS:
${Object.values(audits).filter(a => a.score !== null && a.score < 0.5).map(a => `- ${a.title}`).join('\n')}

Format your response as Markdown with:
## üìä Resumo
## ‚ö†Ô∏è Pontos de Aten√ß√£o  
## üí° Recomenda√ß√µes
## üéØ Prioridades`;

        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${settings.geminiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        
        const json = await res.json();
        const analysis = json.candidates?.[0]?.content?.parts?.[0]?.text || 'Analysis failed';
        
        // Save to localStorage
        const analysisKey = `lh_analysis_${filename}`;
        localStorage.setItem(analysisKey, analysis);
        
        // Render
        analysisEl.innerHTML = marked.parse(analysis) + `
          <div class="border-t border-white/10 pt-4 mt-4 flex gap-2">
            <button onclick="copyAnalysis('${analysisKey}')" class="text-xs bg-surfaceHighlight px-3 py-1 rounded text-muted hover:text-white">üìã Copy</button>
            <button onclick="saveAnalysisFile('${filename}')" class="text-xs bg-surfaceHighlight px-3 py-1 rounded text-muted hover:text-white">üíæ Save MD</button>
          </div>
        `;
        
      } catch (e) {
        analysisEl.innerHTML = `<div class="text-error">Error: ${e.message}</div>`;
      }
    }

    function copyAnalysis(key) {
      const analysis = localStorage.getItem(key);
      if (analysis) {
        navigator.clipboard.writeText(analysis);
        alert('Analysis copied to clipboard!');
      }
    }

    function saveAnalysisFile(filename) {
      const key = `lh_analysis_${filename}`;
      const analysis = localStorage.getItem(key);
      if (!analysis) return;
      
      const blob = new Blob([analysis], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `lighthouse-analysis-${filename.replace('.json', '')}.md`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportReportMarkdown(filename) {
      const report = window.currentLighthouseReport?.data;
      if (!report) return;
      
      const cats = report.categories;
      const audits = report.audits;
      
      let md = `# Lighthouse Report: ${filename}\n\n`;
      md += `**URL:** ${report.finalUrl}\n`;
      md += `**Date:** ${new Date(report.fetchTime).toLocaleString()}\n`;
      md += `**Device:** ${report.configSettings?.formFactor || 'N/A'}\n\n`;
      
      md += `## Scores\n\n`;
      md += `| Category | Score |\n|----------|-------|\n`;
      ['performance', 'accessibility', 'best-practices', 'seo'].forEach(cat => {
        md += `| ${cat} | ${Math.round((cats[cat]?.score || 0) * 100)}% |\n`;
      });
      
      md += `\n## Core Web Vitals\n\n`;
      md += `| Metric | Value |\n|--------|-------|\n`;
      md += `| LCP | ${audits['largest-contentful-paint']?.displayValue || '-'} |\n`;
      md += `| FCP | ${audits['first-contentful-paint']?.displayValue || '-'} |\n`;
      md += `| CLS | ${audits['cumulative-layout-shift']?.displayValue || '-'} |\n`;
      md += `| TBT | ${audits['total-blocking-time']?.displayValue || '-'} |\n`;
      
      const failed = Object.values(audits).filter(a => a.score !== null && a.score < 0.5);
      if (failed.length > 0) {
        md += `\n## Failed Audits\n\n`;
        failed.forEach(a => {
          md += `### ${a.title}\n${a.description || ''}\n\n`;
        });
      }
      
      const blob = new Blob([md], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `lighthouse-report-${filename.replace('.json', '')}.md`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function openReportConsole(filename) {
      const report = window.currentLighthouseReport?.data;
      if (!report) return;
      
      const modal = document.getElementById('terminal-modal');
      const content = document.getElementById('terminal-content');
      const title = document.getElementById('terminal-title');
      
      modal.classList.remove('hidden');
      title.innerText = `Raw JSON: ${filename}`;
      content.innerHTML = `<pre class="text-xs">${JSON.stringify(report, null, 2)}</pre>`;
    }

    // --- Logs View ---
    async function loadLogsView() {
      const container = document.getElementById('content-area');
      container.innerHTML = `<h1 class="text-2xl font-bold text-white mb-6">üìù Logs</h1><div id="logs-list" class="space-y-2">Loading...</div>`;
      
      const res = await fetch(`${API_BASE}/logs`);
      const json = await res.json();
      
      const list = document.getElementById('logs-list');
      if (!json.data || json.data.length === 0) {
        list.innerHTML = '<div class="p-8 text-center text-muted border border-dashed border-white/10 rounded-xl">No logs found.</div>';
        return;
      }
      
      list.innerHTML = json.data.map(log => `
        <div class="glass-card p-4 cursor-pointer hover:bg-white/5 transition" onclick="viewLog('${log.filename}')">
          <div class="flex justify-between items-center">
            <span class="font-mono text-sm text-primary">${log.filename}</span>
            <span class="text-xs text-muted">${new Date(log.timestamp).toLocaleDateString()}</span>
          </div>
        </div>
      `).join('');
    }

    async function viewLog(filename) {
      const res = await fetch(`${API_BASE}/logs`);
      const json = await res.json();
      const log = json.data.find(l => l.filename === filename);

      const container = document.getElementById('content-area');
      if(log) {
        container.innerHTML = `
          <button onclick="switchTab('logs')" class="mb-4 text-sm text-muted hover:text-white flex items-center gap-2">‚Üê Back to Logs</button>
          <div class="glass-card p-8 prose max-w-none">
            ${log.html}
          </div>
        `;
      }
    }

    // --- Profile View ---
    async function loadProfileView() {
      const container = document.getElementById('content-area');
      const settings = getSettings();
      
      if (!settings.monitorUrl) {
        container.innerHTML = `
          <div class="glass-card p-8 text-center">
            <div class="text-4xl mb-4">üìã</div>
            <h3 class="text-lg font-bold text-white mb-2">No Site Configured</h3>
            <p class="text-muted mb-4">Configure your site in Settings to view profile.</p>
            <button onclick="openSettings()" class="px-6 py-3 bg-primary text-black font-bold rounded-lg">Open Settings</button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `
        <!-- Compact Header -->
        <div class="flex flex-wrap items-center justify-between gap-3 mb-6 pb-3 border-b border-white/10">
          <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold text-white">${settings.projectName || 'Site Profile'}</h1>
            <span class="text-xs text-muted font-mono">${settings.monitorUrl}</span>
            ${settings.githubRepo ? `<a href="https://github.com/${settings.githubRepo}" target="_blank" class="text-xs text-primary hover:underline">üìÇ ${settings.githubRepo}</a>` : ''}
          </div>
          <button onclick="openSettings()" class="px-3 py-1 bg-white/5 text-muted rounded text-xs hover:bg-white/10">‚öôÔ∏è Edit</button>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="glass-card p-4 text-center">
            <div class="text-2xl font-bold font-mono text-white" id="stat-total-scans">-</div>
            <div class="text-xs text-muted">Total Scans</div>
          </div>
          <div class="glass-card p-4 text-center">
            <div class="text-2xl font-bold font-mono" id="stat-avg-build">-</div>
            <div class="text-xs text-muted">Avg Build</div>
          </div>
          <div class="glass-card p-4 text-center">
            <div class="text-2xl font-bold font-mono" id="stat-avg-render">-</div>
            <div class="text-xs text-muted">Avg Render</div>
          </div>
          <div class="glass-card p-4 text-center">
            <div class="text-2xl font-bold font-mono" id="stat-pass-rate">-</div>
            <div class="text-xs text-muted">Pass Rate</div>
          </div>
        </div>

        <!-- Historical Chart -->
        <div class="glass-card p-6 mb-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-sm font-medium text-muted uppercase tracking-widest">üìà Score History</h3>
            <button onclick="exportProfileChartSVG()" class="px-2 py-1 text-xs bg-surfaceHighlight text-muted rounded hover:text-white">üíæ SVG</button>
          </div>
          <div class="h-48">
            <canvas id="profile-chart"></canvas>
          </div>
        </div>

        <!-- README -->
        <div class="glass-card p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-sm font-medium text-muted uppercase tracking-widest">README.md</h3>
            <span class="text-xs text-muted">üìÑ</span>
          </div>
          <div id="readme-content" class="prose max-w-none text-sm overflow-auto max-h-[40vh]">Loading...</div>
        </div>
      `;
      
      // Load historical data
      loadProfileStats();
      
      // Fetch README
      if (settings.githubRepo && settings.githubToken) {
        try {
          const [owner, repo] = settings.githubRepo.split('/');
          const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/readme`, {
            headers: { Authorization: `token ${settings.githubToken}`, Accept: 'application/vnd.github.v3.raw' }
          });
          if (res.ok) {
            const readme = await res.text();
            document.getElementById('readme-content').innerHTML = marked.parse(readme);
          } else {
            document.getElementById('readme-content').innerHTML = '<div class="text-muted italic">README not found</div>';
          }
        } catch (e) {
          document.getElementById('readme-content').innerHTML = '<div class="text-error">Failed to load README</div>';
        }
      } else {
        document.getElementById('readme-content').innerHTML = '<div class="text-muted italic">Configure GitHub token to view README</div>';
      }
    }

    let profileChart = null;
    async function loadProfileStats() {
      try {
        const res = await fetch(`${API_BASE}/reports/quality`);
        const json = await res.json();
        const reports = json.data || [];
        
        if (reports.length === 0) {
          document.getElementById('stat-total-scans').textContent = '0';
          return;
        }
        
        // Calculate stats
        const buildScores = reports.map(r => r.data?.scores?.build || 0).filter(s => s > 0);
        const renderScores = reports.map(r => r.data?.scores?.render || 0).filter(s => s > 0);
        const passCount = reports.filter(r => r.data?.status === 'pass').length;
        
        const avgBuild = buildScores.length > 0 ? Math.round(buildScores.reduce((a, b) => a + b, 0) / buildScores.length) : 0;
        const avgRender = renderScores.length > 0 ? Math.round(renderScores.reduce((a, b) => a + b, 0) / renderScores.length) : 0;
        const passRate = Math.round((passCount / reports.length) * 100);
        
        const getColor = (s) => s >= 90 ? 'text-success' : (s >= 50 ? 'text-warning' : 'text-error');
        
        document.getElementById('stat-total-scans').textContent = reports.length;
        document.getElementById('stat-avg-build').textContent = avgBuild;
        document.getElementById('stat-avg-build').className = `text-2xl font-bold font-mono ${getColor(avgBuild)}`;
        document.getElementById('stat-avg-render').textContent = avgRender;
        document.getElementById('stat-avg-render').className = `text-2xl font-bold font-mono ${getColor(avgRender)}`;
        document.getElementById('stat-pass-rate').textContent = `${passRate}%`;
        document.getElementById('stat-pass-rate').className = `text-2xl font-bold font-mono ${getColor(passRate)}`;
        
        // Render chart
        const canvas = document.getElementById('profile-chart');
        if (!canvas) return;
        
        const recentReports = reports.slice(0, 20).reverse();
        const labels = recentReports.map(r => {
          const d = new Date(r.timestamp);
          return `${d.getDate()}/${d.getMonth()+1} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
        });
        
        if (profileChart) profileChart.destroy();
        
        profileChart = new Chart(canvas, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'Build', data: recentReports.map(r => r.data?.scores?.build || 0), borderColor: '#22d3ee', backgroundColor: 'rgba(34, 211, 238, 0.1)', fill: true, tension: 0.3 },
              { label: 'Render', data: recentReports.map(r => r.data?.scores?.render || 0), borderColor: '#f59e0b', tension: 0.3 },
              { label: 'UX', data: recentReports.map(r => r.data?.scores?.ux || 0), borderColor: '#a855f7', tension: 0.3 },
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              legend: { display: true, position: 'top', labels: { color: '#a3a3a3', font: { size: 10 }, boxWidth: 12 } },
              title: { display: true, text: `Last ${recentReports.length} scans`, color: '#666', font: { size: 11 } }
            },
            scales: {
              x: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#666', font: { size: 9 }, maxRotation: 45 } },
              y: { min: 0, max: 100, grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#666' } }
            }
          }
        });
      } catch (e) {
        console.error('Failed to load profile stats:', e);
      }
    }

    function exportProfileChartSVG() {
      const canvas = document.getElementById('profile-chart');
      if (!canvas) return;
      
      const dataUrl = canvas.toDataURL('image/png');
      const settings = getSettings();
      const siteName = (settings.projectName || 'profile').replace(/[^a-z0-9]/gi, '-');
      
      const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="${canvas.width}" height="${canvas.height}">
  <image width="${canvas.width}" height="${canvas.height}" xlink:href="${dataUrl}"/>
</svg>`;
      
      const blob = new Blob([svg], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `profile-chart-${siteName}.svg`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // --- PageSpeed View ---
    async function loadPageSpeedView() {
      const container = document.getElementById('content-area');
      const settings = getSettings();
      
      container.innerHTML = `
        <header class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-3xl font-bold text-white mb-2">üî• PageSpeed Insights</h1>
            <p class="text-muted text-sm">Remote Lighthouse test via Google API</p>
          </div>
          <button onclick="runPageSpeedTest()" class="px-4 py-2 bg-primary/10 text-primary border border-primary/50 rounded-lg hover:bg-primary hover:text-black transition text-sm font-bold flex items-center gap-2" ${!settings.monitorUrl ? 'disabled' : ''}>
            üöÄ Run Test
          </button>
        </header>

        ${!settings.monitorUrl ? `
          <div class="glass-card p-8 text-center">
            <p class="text-muted mb-4">Configure your site URL in Settings first.</p>
            <button onclick="openSettings()" class="px-6 py-3 bg-primary text-black font-bold rounded-lg">Open Settings</button>
          </div>
        ` : `
          <div id="pagespeed-results" class="space-y-6">
            <div class="glass-card p-6 text-center text-muted">
              <p>Click "Run Test" to analyze ${settings.monitorUrl}</p>
              ${!settings.pagespeedKey ? '<p class="text-xs text-warning mt-2">No API key set - using anonymous quota (limited)</p>' : '<p class="text-xs text-success mt-2">‚úì API key configured</p>'}
            </div>
          </div>
        `}
      `;
    }

    async function runPageSpeedTest() {
      const settings = getSettings();
      if (!settings.monitorUrl) return;
      
      const resultsEl = document.getElementById('pagespeed-results');
      resultsEl.innerHTML = '<div class="glass-card p-8 text-center text-muted animate-pulse">Running PageSpeed test... (this may take 30-60 seconds)</div>';
      
      try {
        const key = settings.pagespeedKey || '';
        const res = await fetch(`${API_BASE}/pagespeed?url=${encodeURIComponent(settings.monitorUrl)}&key=${key}&strategy=mobile`);
        const data = await res.json();
        
        if (data.error) {
          resultsEl.innerHTML = `<div class="glass-card p-6 text-error">Error: ${data.error.message || 'Unknown error'}</div>`;
          return;
        }
        
        const lhr = data.lighthouseResult;
        const cats = lhr.categories;
        
        const getColor = (s) => s >= 90 ? 'text-success' : (s >= 50 ? 'text-warning' : 'text-error');
        const getBg = (s) => s >= 90 ? 'bg-success' : (s >= 50 ? 'bg-warning' : 'bg-error');
        
        resultsEl.innerHTML = `
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            ${['performance', 'accessibility', 'best-practices', 'seo'].map(cat => {
              const score = Math.round((cats[cat]?.score || 0) * 100);
              return `
                <div class="glass-card p-4 text-center">
                  <div class="text-3xl font-bold font-mono ${getColor(score)}">${score}</div>
                  <div class="text-xs text-muted uppercase mt-1">${cat.replace('-', ' ')}</div>
                  <div class="w-full bg-white/5 h-1 mt-3 rounded-full overflow-hidden">
                    <div class="h-full ${getBg(score)}" style="width: ${score}%"></div>
                  </div>
                </div>`;
            }).join('')}
          </div>
          
          <div class="glass-card p-6">
            <h3 class="text-sm font-medium text-muted uppercase tracking-widest mb-4">Core Web Vitals</h3>
            <div class="grid grid-cols-3 gap-4">
              <div class="text-center">
                <div class="text-xl font-mono font-bold text-white">${lhr.audits['largest-contentful-paint']?.displayValue || '-'}</div>
                <div class="text-xs text-muted">LCP</div>
              </div>
              <div class="text-center">
                <div class="text-xl font-mono font-bold text-white">${lhr.audits['cumulative-layout-shift']?.displayValue || '-'}</div>
                <div class="text-xs text-muted">CLS</div>
              </div>
              <div class="text-center">
                <div class="text-xl font-mono font-bold text-white">${lhr.audits['total-blocking-time']?.displayValue || '-'}</div>
                <div class="text-xs text-muted">TBT</div>
              </div>
            </div>
          </div>
        `;
      } catch (e) {
        resultsEl.innerHTML = `<div class="glass-card p-6 text-error">Test failed: ${e.message}</div>`;
      }
    }

    // --- Git View ---
    async function loadGitView() {
      const container = document.getElementById('content-area');
      const settings = getSettings();
      
      container.innerHTML = `
        <header class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-3xl font-bold text-white mb-2">üîÄ Git & Deploy</h1>
            <p class="text-muted text-sm">Commit and push changes</p>
          </div>
          <button onclick="loadGitView()" class="px-4 py-2 bg-white/5 text-muted rounded-lg hover:bg-white/10 transition text-sm">‚Üª Refresh</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Git Status -->
          <div class="glass-card p-6">
            <h3 class="text-sm font-medium text-muted uppercase tracking-widest mb-4">Git Status</h3>
            <div id="git-status" class="text-muted">Loading...</div>
          </div>
          
          <!-- Commit Panel -->
          <div class="glass-card p-6">
            <h3 class="text-sm font-medium text-muted uppercase tracking-widest mb-4">Commit Changes</h3>
            <textarea id="commit-message" placeholder="feat: describe your changes" rows="3"
              class="w-full px-4 py-3 bg-surfaceHighlight border border-white/10 rounded-lg text-white placeholder-muted focus:border-primary focus:outline-none resize-none mb-4"></textarea>
            <div class="flex gap-2">
              ${settings.geminiKey ? '<button onclick="generateCommitMessage()" class="flex-1 py-2 bg-purple-500/20 text-purple-400 rounded-lg hover:bg-purple-500/30 transition text-sm font-medium">‚ú® AI Generate</button>' : ''}
              <button onclick="doCommitPush()" class="flex-1 py-2 bg-primary text-black font-bold rounded-lg hover:bg-primary/90 transition">Commit & Push</button>
            </div>
          </div>
        </div>
      `;
      
      // Fetch git status
      try {
        const res = await fetch(`${API_BASE}/git/status`);
        const json = await res.json();
        
        const statusEl = document.getElementById('git-status');
        if (json.success) {
          const { branch, lastCommit, files, hasChanges } = json.data;
          statusEl.innerHTML = `
            <div class="space-y-3">
              <div class="flex justify-between"><span class="text-muted">Branch</span><span class="text-primary font-mono">${branch}</span></div>
              <div class="flex justify-between"><span class="text-muted">Last Commit</span><span class="text-white font-mono text-sm">${lastCommit}</span></div>
              <div class="border-t border-white/10 pt-3 mt-3">
                ${hasChanges ? `
                  <p class="text-warning text-sm mb-2">üìù ${files.length} file(s) changed</p>
                  <div class="max-h-40 overflow-y-auto space-y-1 text-xs font-mono">
                    ${files.map(f => `<div class="flex gap-2"><span class="text-yellow-400">${f.status}</span><span class="text-muted">${f.file}</span></div>`).join('')}
                  </div>
                ` : '<p class="text-success">‚úì Working tree clean</p>'}
              </div>
            </div>
          `;
        } else {
          statusEl.innerHTML = `<div class="text-error">${json.error}</div>`;
        }
      } catch (e) {
        document.getElementById('git-status').innerHTML = `<div class="text-error">Failed to get git status</div>`;
      }
    }

    async function generateCommitMessage() {
      const settings = getSettings();
      if (!settings.geminiKey) {
        alert('Gemini API key required');
        return;
      }
      
      const textarea = document.getElementById('commit-message');
      textarea.value = 'Generating commit message...';
      textarea.disabled = true;
      
      try {
        // Get git diff for context
        const statusRes = await fetch(`${API_BASE}/git/status`);
        const { data } = await statusRes.json();
        const changedFiles = data.files.map(f => f.file).join(', ');
        
        // Use Gemini via CORS (browser SDK would need import, using simple fetch approach)
        const prompt = `Generate a conventional commit message for these changes. Files changed: ${changedFiles}. Be concise, use format: type(scope): description. Only return the commit message, nothing else.`;
        
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${settings.geminiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        const json = await res.json();
        const message = json.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || 'feat: update';
        textarea.value = message;
      } catch (e) {
        textarea.value = 'feat: update';
      }
      textarea.disabled = false;
    }

    async function doCommitPush() {
      const message = document.getElementById('commit-message').value.trim();
      if (!message) {
        alert('Commit message required');
        return;
      }
      
      if (!confirm(`Commit and push with message: "${message}"?`)) return;
      
      try {
        // Commit
        const commitRes = await fetch(`${API_BASE}/git/commit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        const commitJson = await commitRes.json();
        
        if (!commitJson.success) {
          alert('Commit failed: ' + commitJson.error);
          return;
        }
        
        // Push
        const pushRes = await fetch(`${API_BASE}/git/push`, { method: 'POST' });
        const pushJson = await pushRes.json();
        
        if (pushJson.success) {
          alert('‚úì Commit and push successful!');
          document.getElementById('commit-message').value = '';
          loadGitView();
        } else {
          alert('Push failed: ' + pushJson.error);
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // --- Terminal ---
    function runCommand(commandKey) {
      const modal = document.getElementById('terminal-modal');
      const content = document.getElementById('terminal-content');
      const title = document.getElementById('terminal-title');
      
      modal.classList.remove('hidden');
      content.innerHTML = '';
      title.innerText = `Executing: ${commandKey}...`;

      const eventSource = new EventSource(`${API_BASE}/run/${commandKey}`);

      eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        if (data.type === 'stdout' || data.type === 'stderr') {
          const line = document.createElement('div');
          line.textContent = data.output;
          if (data.type === 'stderr') line.classList.add('text-red-400');
          content.appendChild(line);
          content.scrollTop = content.scrollHeight;
        } else if (data.type === 'close') {
          const line = document.createElement('div');
          line.textContent = `\nProcess exited with code ${data.code}`;
          line.classList.add(data.code === 0 ? 'text-success' : 'text-error', 'font-bold', 'mt-2');
          content.appendChild(line);
          eventSource.close();
          
          if(data.code === 0) {
            setTimeout(() => {
              if(currentTab === 'dashboard') loadDashboard();
              if(currentTab === 'quality') loadQualityView();
              if(currentTab === 'reports') loadReportsView();
            }, 1000);
          }
        } else if (data.type === 'error') {
          const line = document.createElement('div');
          line.textContent = `Error: ${data.error}`;
          line.classList.add('text-error');
          content.appendChild(line);
          eventSource.close();
        }
      };

      eventSource.onerror = () => {
        const line = document.createElement('div');
        line.textContent = `\nConnection lost.`;
        line.classList.add('text-error');
        content.appendChild(line);
        eventSource.close();
      };
    }

    function closeTerminal() {
      document.getElementById('terminal-modal').classList.add('hidden');
    }
  </script>
</body>
</html>
